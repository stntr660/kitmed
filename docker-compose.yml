version: '3.8'

services:
  # KITMED Web Application
  kitmed-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kitmed-web
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Database
      - DATABASE_URL=file:/app/data/production.db
      
      # Next.js
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=kitmed-super-secret-key-change-in-production
      
      # Application
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - MAINTENANCE_MODE=false
      
      # File uploads
      - UPLOAD_DIR=/app/uploads
      - MAX_FILE_SIZE=20971520  # 20MB
    
    volumes:
      # Persistent database storage
      - kitmed_data:/app/data
      # Persistent file uploads
      - kitmed_uploads:/app/uploads
      
    networks:
      - kitmed-network
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Database initialization service (runs once)
  kitmed-db-init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kitmed-db-init
    environment:
      - DATABASE_URL=file:/app/data/production.db
    volumes:
      - kitmed_data:/app/data
    networks:
      - kitmed-network
    depends_on:
      - kitmed-app
    command: >
      sh -c "
        echo 'Initializing database...'
        npx prisma db push --accept-data-loss
        echo 'Database initialized successfully!'
      "
    restart: "no"

  # Nginx reverse proxy (optional, for production)
  kitmed-proxy:
    image: nginx:alpine
    container_name: kitmed-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/ssl:ro
      - kitmed_uploads:/var/www/uploads:ro  # Serve uploads directly
    depends_on:
      - kitmed-app
    networks:
      - kitmed-network
    profiles:
      - production  # Only start in production profile

# Persistent volumes
volumes:
  kitmed_data:
    driver: local
    driver_opts:
      type: none
      device: ./docker/data
      o: bind
  
  kitmed_uploads:
    driver: local
    driver_opts:
      type: none  
      device: ./public/uploads
      o: bind

# Custom network
networks:
  kitmed-network:
    driver: bridge